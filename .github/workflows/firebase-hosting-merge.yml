# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting and Functions on merge
on:
  push:
    branches:
      - main
      - develop
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || github.ref_name == 'develop' && 'development' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      # Build React app
      - name: Install and build React app
        run: pnpm install --frozen-lockfile && pnpm run build
        env:
          REACT_APP_FIREBASE_API_KEY: ${{ secrets.REACT_APP_FIREBASE_API_KEY }}
          REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ vars.REACT_APP_FIREBASE_AUTH_DOMAIN }}
          REACT_APP_FIREBASE_PROJECT_ID: ${{ vars.REACT_APP_FIREBASE_PROJECT_ID }}
          REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ vars.REACT_APP_FIREBASE_STORAGE_BUCKET }}
          REACT_APP_FIREBASE_DATABASE_ID: ${{ vars.REACT_APP_FIREBASE_DATABASE_ID }}
          REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.REACT_APP_FIREBASE_MESSAGING_SENDER_ID }}
          REACT_APP_FIREBASE_APP_ID: ${{ vars.REACT_APP_FIREBASE_APP_ID }}

      # Build Cloud Functions
      - name: Install and build Cloud Functions
        run: |
          cd functions
          npm ci
          npm run build

      # Deploy Firebase Hosting
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ vars.REACT_APP_FIREBASE_PROJECT_ID }}

      # Set up Google Cloud SDK for secret management
      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2
        with:
          project_id: ${{ vars.REACT_APP_FIREBASE_PROJECT_ID }}

      # Authenticate with GCP using service account
      - name: Authenticate to GCP
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      # Create or update SendGrid API key in Secret Manager
      - name: Configure SendGrid secret
        run: |
          PROJECT_ID="${{ vars.REACT_APP_FIREBASE_PROJECT_ID }}"
          SECRET_NAME="SENDGRID_API_KEY"

          # Check if secret exists
          if gcloud secrets describe $SECRET_NAME --project=$PROJECT_ID > /dev/null 2>&1; then
            # Secret exists, add new version
            echo -n "${{ secrets.SENDGRID_API_KEY }}" | gcloud secrets versions add $SECRET_NAME --data-file=- --project=$PROJECT_ID
          else
            # Secret doesn't exist, create it
            echo -n "${{ secrets.SENDGRID_API_KEY }}" | gcloud secrets create $SECRET_NAME --data-file=- --project=$PROJECT_ID
          fi

          # Get the Cloud Functions service account email
          SA_EMAIL="${PROJECT_ID}@appspot.gserviceaccount.com"

          # Grant access to the secret (idempotent operation)
          gcloud secrets add-iam-policy-binding $SECRET_NAME \
            --member="serviceAccount:${SA_EMAIL}" \
            --role="roles/secretmanager.secretAccessor" \
            --project=$PROJECT_ID --quiet || true

      # Deploy Cloud Functions
      - name: Deploy Cloud Functions
        run: |
          # Create .env file for Firebase Functions params
          echo "SENDER_EMAIL=${{ vars.SENDER_EMAIL }}" > functions/.env
          echo "SENDER_NAME=${{ vars.SENDER_NAME }}" >> functions/.env
          echo "APP_URL=${{ vars.APP_URL }}" >> functions/.env
          echo "USE_SENDGRID=${{ vars.USE_SENDGRID }}" >> functions/.env
          echo "REPLY_TO_EMAIL=${{ vars.REPLY_TO_EMAIL }}" >> functions/.env
          echo "STORAGE_BUCKET=${{ vars.REACT_APP_FIREBASE_STORAGE_BUCKET }}" >> functions/.env

          npm install -g firebase-tools
          firebase deploy --only functions --project ${{ vars.REACT_APP_FIREBASE_PROJECT_ID }} --force

          # Clean up
          rm -f functions/.env
