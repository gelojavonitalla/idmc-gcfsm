# This file was auto-generated by the Firebase CLI
# https://github.com/firebase/firebase-tools

name: Deploy to Firebase Hosting and Functions on merge
on:
  push:
    branches:
      - main
      - develop
jobs:
  build_and_deploy:
    runs-on: ubuntu-latest
    environment: ${{ github.ref_name == 'main' && 'production' || github.ref_name == 'develop' && 'development' }}
    steps:
      - uses: actions/checkout@v4
      - uses: pnpm/action-setup@v4
        with:
          version: 10
      - uses: actions/setup-node@v4
        with:
          node-version: 22
          cache: 'pnpm'

      # Build React app
      - name: Install and build React app
        run: pnpm install --frozen-lockfile && pnpm run build
        env:
          REACT_APP_FIREBASE_API_KEY: ${{ secrets.REACT_APP_FIREBASE_API_KEY }}
          REACT_APP_FIREBASE_AUTH_DOMAIN: ${{ vars.REACT_APP_FIREBASE_AUTH_DOMAIN }}
          REACT_APP_FIREBASE_PROJECT_ID: ${{ vars.REACT_APP_FIREBASE_PROJECT_ID }}
          REACT_APP_FIREBASE_STORAGE_BUCKET: ${{ vars.REACT_APP_FIREBASE_STORAGE_BUCKET }}
          REACT_APP_FIREBASE_MESSAGING_SENDER_ID: ${{ vars.REACT_APP_FIREBASE_MESSAGING_SENDER_ID }}
          REACT_APP_FIREBASE_APP_ID: ${{ vars.REACT_APP_FIREBASE_APP_ID }}

      # Build Cloud Functions
      - name: Install and build Cloud Functions
        run: |
          cd functions
          npm ci
          npm run build

      # Deploy Firebase Hosting
      - name: Deploy to Firebase Hosting
        uses: FirebaseExtended/action-hosting-deploy@v0
        with:
          repoToken: ${{ secrets.GITHUB_TOKEN }}
          firebaseServiceAccount: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}
          channelId: live
          projectId: ${{ vars.REACT_APP_FIREBASE_PROJECT_ID }}

      # Authenticate with Google Cloud
      - name: Authenticate to Google Cloud
        id: auth
        uses: google-github-actions/auth@v2
        with:
          credentials_json: ${{ secrets.FIREBASE_SERVICE_ACCOUNT }}

      - name: Set up Cloud SDK
        uses: google-github-actions/setup-gcloud@v2

      # Grant required IAM roles for Cloud Functions with Eventarc triggers
      - name: Grant IAM roles for Cloud Functions
        run: |
          PROJECT_ID="${{ vars.REACT_APP_FIREBASE_PROJECT_ID }}"
          PROJECT_NUMBER=$(gcloud projects describe "$PROJECT_ID" --format='value(projectNumber)')

          echo "Granting IAM roles for project $PROJECT_ID (number: $PROJECT_NUMBER)"

          # Grant Service Account Token Creator to Pub/Sub service account
          # Required for Eventarc to create authentication tokens
          gcloud projects add-iam-policy-binding "$PROJECT_ID" \
            --member="serviceAccount:service-${PROJECT_NUMBER}@gcp-sa-pubsub.iam.gserviceaccount.com" \
            --role="roles/iam.serviceAccountTokenCreator" \
            --condition=None \
            --quiet || echo "Role may already be granted or insufficient permissions"

          # Grant Cloud Run Invoker to default compute service account
          # Required for Eventarc to invoke Cloud Functions
          gcloud projects add-iam-policy-binding "$PROJECT_ID" \
            --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
            --role="roles/run.invoker" \
            --condition=None \
            --quiet || echo "Role may already be granted or insufficient permissions"

          # Grant Eventarc Event Receiver to default compute service account
          # Required for Cloud Functions to receive Firestore trigger events
          gcloud projects add-iam-policy-binding "$PROJECT_ID" \
            --member="serviceAccount:${PROJECT_NUMBER}-compute@developer.gserviceaccount.com" \
            --role="roles/eventarc.eventReceiver" \
            --condition=None \
            --quiet || echo "Role may already be granted or insufficient permissions"

      # Deploy Cloud Functions
      - name: Deploy Cloud Functions
        run: |
          # Create .env file for Firebase Functions params
          echo "SENDER_EMAIL=${{ vars.SENDER_EMAIL }}" > functions/.env
          echo "SENDER_NAME=${{ vars.SENDER_NAME }}" >> functions/.env
          echo "APP_URL=${{ vars.APP_URL }}" >> functions/.env
          echo "USE_SENDGRID=${{ vars.USE_SENDGRID }}" >> functions/.env

          npm install -g firebase-tools
          firebase deploy --only functions --project ${{ vars.REACT_APP_FIREBASE_PROJECT_ID }} --force

          # Clean up
          rm -f functions/.env
