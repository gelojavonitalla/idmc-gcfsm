rules_version = '2';

/**
 * Firebase Storage Security Rules for IDMC Conference
 *
 * Security Model:
 * - Public images (hero, speakers) are readable by anyone
 * - Payment proofs are only readable by authenticated admins
 * - Uploads require authentication for most paths, except payment proofs
 *
 * Storage paths:
 * - conference/hero-images/{filename} - Hero images for the conference
 * - conference/hero-videos/{filename} - Hero videos for the conference
 * - speakers/photos/{speakerId}/{filename} - Speaker profile photos
 * - registrations/payment-proofs/{registrationId}/{filename} - Payment receipts
 * - registrations/invoices/{registrationId}/{filename} - Invoice files
 */
service firebase.storage {
  match /b/{bucket}/o {

    // ============================================
    // Helper Functions
    // ============================================

    /**
     * Check if user is authenticated
     */
    function isAuthenticated() {
      return request.auth != null;
    }

    /**
     * Validate image file (type and size)
     * Allows common image formats up to 10MB
     */
    function isValidImage() {
      return request.resource.contentType.matches('image/.*')
        && request.resource.size < 10 * 1024 * 1024; // 10MB max
    }

    /**
     * Validate video file (type and size)
     * Allows common video formats up to 100MB
     */
    function isValidVideo() {
      return request.resource.contentType.matches('video/.*')
        && request.resource.size < 100 * 1024 * 1024; // 100MB max
    }

    /**
     * Validate payment proof file (image or PDF)
     * Allows images and PDFs up to 5MB
     */
    function isValidPaymentProof() {
      return (request.resource.contentType.matches('image/.*') ||
              request.resource.contentType == 'application/pdf')
        && request.resource.size < 5 * 1024 * 1024; // 5MB max
    }

    /**
     * Validate invoice file (image or PDF)
     * Allows images and PDFs up to 10MB
     */
    function isValidInvoice() {
      return (request.resource.contentType.matches('image/.*') ||
              request.resource.contentType == 'application/pdf')
        && request.resource.size < 10 * 1024 * 1024; // 10MB max
    }

    // ============================================
    // Public Content Rules
    // ============================================

    /**
     * Conference hero images
     * - Public read access (displayed on website)
     * - Only authenticated users can upload
     */
    match /conference/hero-images/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isValidImage();
    }

    /**
     * Conference hero videos
     * - Public read access (displayed on website)
     * - Only authenticated users can upload
     */
    match /conference/hero-videos/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isValidVideo();
    }

    /**
     * Speaker photos
     * - Public read access (displayed on website)
     * - Only authenticated users can upload
     */
    match /speakers/photos/{speakerId}/{fileName} {
      allow read: if true;
      allow write: if isAuthenticated() && isValidImage();
    }

    // ============================================
    // Sensitive Content Rules
    // ============================================

    /**
     * Registration payment proofs
     *
     * SECURITY: Payment proofs may contain sensitive financial information
     * such as bank account numbers, transaction details, etc.
     *
     * - Read: Only authenticated users (admins verify via Cloud Functions)
     * - Write: Public can upload (for registration form without auth)
     *         but must be valid file type and size
     *
     * Note: For admin verification, use Cloud Functions to generate
     * signed URLs with limited expiration time.
     */
    match /registrations/payment-proofs/{registrationId}/{fileName} {
      // Only authenticated users can read payment proofs
      // Admins access these for payment verification
      allow read: if isAuthenticated();

      // Public can upload payment proofs during registration
      // File type and size are validated
      allow write: if isValidPaymentProof();
    }

    /**
     * Registration invoices
     *
     * - Read: Only authenticated users (admins and Cloud Functions)
     * - Write: Only authenticated users (admins upload invoices)
     */
    match /registrations/invoices/{registrationId}/{fileName} {
      allow read: if isAuthenticated();
      allow write: if isAuthenticated() && isValidInvoice();
    }

    // ============================================
    // Default Rule
    // ============================================

    /**
     * Catch-all rule: Deny access to any undefined paths
     * This prevents accidental exposure of files in new paths
     */
    match /{allPaths=**} {
      allow read, write: if false;
    }
  }
}
